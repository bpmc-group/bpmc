{% extends "administration/admin_std_template.html" %}

<title>{% block title %}User Management{% endblock %}</title>

{% block content %}
    <div class="container">
        <!-- Header -->
        <div class="top-bar">
            <span>User Management</span>
            <a href="http://127.0.0.1:8000/auth/home/" class="home-icon">&#x2302; Home</a>
        </div>

        <!-- Top Container -->
        <div class="actions-container">
            <div class="search-bar">
                <input type="text" id="search-input" class="form-control" placeholder="Search users...">
                <button class="btn btn-primary" onclick="searchUsers()">Search</button>
            </div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="saveChanges()">Save Changes</button>
                <button class="btn btn-danger" onclick="deleteSelected()">Delete Selected</button>
            </div>
        </div>

        <!-- container -->
        <div class="table-container">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all" onclick="selectAllUsers(this)"></th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Hire Date</th>
                        <th>Employment Status</th>
                        <th>Username</th>
                        <th>User Status</th>
                        <th>Primary Job</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <!-- Rows will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const usersTableBody = document.getElementById("users-table-body");
        let usersData = [];

        // Fetch users
        async function fetchUsers() {
            try {
                console.log("Fetching users...");
                const response = await fetch('/api/users/');
                if (!response.ok) throw new Error(`Failed to fetch users: ${response.status}`);
                usersData = await response.json();
                console.log("Fetched users:", usersData);
                populateTable(usersData);
            } catch (error) {
                console.error(error);
            }
        }

        // Populate the table
        function populateTable(users) {
            usersTableBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="select-user" data-id="${user.id}"></td>
                    <td contenteditable="true" data-field="first_name">${user.first_name || 'N/A'}</td>
                    <td contenteditable="true" data-field="last_name">${user.last_name || 'N/A'}</td>
                    <td contenteditable="true" data-field="email">${user.email || 'N/A'}</td>
                    <td contenteditable="true" data-field="hire_date">${user.hire_date || 'N/A'}</td>
                    <td contenteditable="true" data-field="employment_status">${user.employment_status || 'N/A'}</td>
                    <td contenteditable="true" data-field="username">${user.username || 'N/A'}</td>
                    <td contenteditable="true" data-field="user_status">${user.user_status || 'N/A'}</td>
                    <td contenteditable="true" data-field="primary_job">${user.primary_job || 'N/A'}</td>
                `;
                usersTableBody.appendChild(row);
            });
        }

        async function updateUser(id, data) {
            try {
                const response = await fetch(`/api/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                console.log(`Update response for user ID ${id}:`, response);
                if (!response.ok) throw new Error('Update failed');
            } catch (error) {
                console.error(error);
            }
        }

        async function deleteSelected() {
            const selectedIds = Array.from(document.querySelectorAll('.select-user:checked')).map(checkbox => checkbox.getAttribute('data-id'));
            for (const id of selectedIds) {
                try {
                    const response = await fetch(`/api/users/${id}`, { method: 'DELETE' });
                    console.log(`Delete response for user ID ${id}:`, response);
                } catch (error) {
                    console.error(error);
                }
            }
            fetchUsers();
        }

        fetchUsers();
    </script>
{% endblock %}